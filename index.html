<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ•…äº‹æ”¶è—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #fffaf6;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 40px);
        }

        .header {
            background: linear-gradient(135deg, #ff9a76 0%, #f99185 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .toolbar {
            background: #fff5ed;
            padding: 20px 30px;
            border-bottom: 2px solid #ffe4d6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
        }

        .tabs-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            flex: 1;
        }

        .tab {
            padding: 10px 20px;
            background: white;
            border: 2px solid #ffd4ba;
            border-radius: 8px;
            cursor: move;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
        }

        .tab.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .tab.drag-over {
            border-color: #ff6b4a;
            background: #ffe8e0;
            transform: scale(1.05);
        }

        .tab:hover {
            border-color: #ff9a76;
            background: #fff5ed;
        }

        .tab.active {
            background: #ff9a76;
            color: white;
            border-color: #ff9a76;
        }

        .tab-delete {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 12px;
            line-height: 1;
        }

        .tab:hover .tab-delete {
            display: none;
        }

        .tab.active .tab-delete {
            display: none;
        }

        .tab-delete:hover {
            background: #ff5252;
        }

        .story-count {
            background: rgba(255, 154, 118, 0.2);
            color: #d97555;
            padding: 2px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .tab.active .story-count {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .toolbar-actions {
            display: flex;
            gap: 10px;
        }

        .btn-export, .btn-import {
            background: #8d6e63;
            color: white;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-export:hover, .btn-import:hover {
            background: #6d4c41;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(141, 110, 99, 0.3);
        }

        #importFile {
            display: none;
        }

        #importTxtFile {
            display: none;
        }

        .content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .stories-list-panel {
            width: 350px;
            background: #fff8f3;
            border-right: 2px solid #ffe4d6;
            overflow-y: auto;
            padding: 20px;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .stories-list-panel.compact {
            width: 280px;
        }

        .stories-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ffe4d6;
        }

        .list-title {
            font-size: 1.1em;
            font-weight: bold;
            color: #8b5a3c;
        }

        .btn-delete-category {
            background: #ff8a65;
            color: white;
            padding: 6px 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            font-family: inherit;
        }

        .btn-delete-category:hover {
            background: #ff7043;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(255, 138, 101, 0.3);
        }

        .story-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #ff9a76;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.3s;
        }

        .story-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            background: #fffbf8;
        }

        .story-item.active {
            background: #fff0e8;
            border-left-color: #f9845b;
            box-shadow: 0 4px 12px rgba(255, 154, 118, 0.2);
        }

        .story-title {
            font-size: 1.05em;
            font-weight: bold;
            color: #5d4037;
            margin-bottom: 5px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .story-meta {
            font-size: 0.8em;
            color: #a1887f;
            margin-bottom: 8px;
        }

        .story-preview-text {
            font-size: 0.9em;
            color: #8d6e63;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.4;
        }

        .story-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .story-item.drag-over {
            border-left-color: #ff6b4a;
            background: #ffe8e0;
            transform: translateX(10px) scale(1.02);
        }

        .preview-panel {
            flex: 1;
            padding: 40px;
            background: #fffaf6;
            overflow-y: auto;
            display: none;
        }

        .preview-panel.active {
            display: block;
        }

        .preview-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #ffe4d6;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .preview-title {
            font-size: 2em;
            font-weight: bold;
            color: #5d4037;
            line-height: 1.4;
            flex: 1;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
            margin-left: 20px;
            flex-shrink: 0;
        }

        .preview-content {
            color: #6d4c41;
            line-height: 2;
            white-space: pre-wrap;
            font-size: 1.05em;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #ffe4d6;
        }

        .pagination-controls button {
            padding: 8px 20px;
            background: #ff9a76;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            transition: all 0.3s;
        }

        .pagination-controls button:hover:not(:disabled) {
            background: #ff8a65;
            transform: translateY(-2px);
        }

        .pagination-controls button:disabled {
            background: #d7ccc8;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .page-info {
            color: #8d6e63;
            font-size: 0.95em;
            min-width: 100px;
            text-align: center;
        }

        .list-meta {
            font-size: 0.85em;
            color: #a1887f;
            margin-top: 5px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #bcaaa4;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            font-family: inherit;
            font-weight: 500;
        }

        .btn-edit {
            background: #ffa726;
            color: white;
        }

        .btn-edit:hover {
            background: #fb8c00;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(255, 167, 38, 0.3);
        }

        .btn-delete {
            background: #ef5350;
            color: white;
        }

        .btn-delete:hover {
            background: #e53935;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(239, 83, 80, 0.3);
        }

        .btn-add {
            background: #ff9a76;
            color: white;
        }

        .btn-add:hover {
            background: #ff8a65;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(255, 154, 118, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 1.5em;
            margin-bottom: 20px;
            color: #333;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            min-height: 250px;
            resize: vertical;
            line-height: 1.6;
        }

        .ai-assist-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-ai {
            background: #9575cd;
            color: white;
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .btn-ai:hover {
            background: #7e57c2;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(149, 117, 205, 0.3);
        }

        .btn-ai:disabled {
            background: #d1c4e9;
            cursor: not-allowed;
            transform: none;
        }

        .ai-status {
            font-size: 0.85em;
            color: #9575cd;
            margin-top: 8px;
            font-style: italic;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .btn-primary {
            background: #ff9a76;
            color: white;
            padding: 10px 20px;
        }

        .btn-primary:hover {
            background: #ff8a65;
        }

        .btn-secondary {
            background: #bcaaa4;
            color: white;
            padding: 10px 20px;
        }

        .btn-secondary:hover {
            background: #a1887f;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š æˆ‘çš„æ•…äº‹æ”¶è—</h1>
            <p>ç®¡ç†ä½ çš„æ•…äº‹ä¸–ç•Œ</p>
        </div>
        
        <div class="toolbar">
            <div class="tabs-container" id="tabsContainer"></div>
            <div class="toolbar-actions">
                <button class="btn btn-export" onclick="exportCategoryAsTxt()">ğŸ“¦ åŒ¯å‡ºæ•…äº‹ç¾¤</button>
                <button class="btn btn-export" onclick="exportData()">ğŸ“¥ åŒ¯å‡ºè³‡æ–™</button>
                <label for="importFile" class="btn btn-import" style="margin: 0; cursor: pointer;">ğŸ“¤ åŒ¯å…¥è³‡æ–™</label>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)">
                <label for="importTxtFile" class="btn btn-import" style="margin: 0; cursor: pointer;">ğŸ“ åŒ¯å…¥TXT</label>
                <input type="file" id="importTxtFile" accept=".txt" onchange="importTxtFile(event)">
                <button class="btn btn-add" onclick="openAddCategoryModal()">+ æ–°å¢æ•…äº‹ç¾¤</button>
                <button class="btn btn-add" onclick="openAddStoryModal()">+ æ–°å¢æ•…äº‹</button>
            </div>
        </div>

        <div class="content">
            <div class="stories-list-panel" id="storiesListPanel">
                <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“–</div>
                    <p>è«‹é¸æ“‡ä¸€å€‹æ•…äº‹ç¾¤</p>
                </div>
            </div>
            <div class="preview-panel" id="previewPanel">
                <div class="empty-state">
                    <div class="empty-state-icon">âœ¨</div>
                    <p>é»æ“Šå·¦å´æ•…äº‹æŸ¥çœ‹å…§å®¹</p>
                </div>
            </div>
        </div>
    </div>

    <!-- æ–°å¢æ•…äº‹ç¾¤çš„å½ˆçª— -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°å¢æ•…äº‹ç¾¤</div>
            <form id="categoryForm">
                <div class="form-group">
                    <label for="categoryName">æ•…äº‹ç¾¤åç¨±ï¼š</label>
                    <input type="text" id="categoryName" required placeholder="è¼¸å…¥æ•…äº‹ç¾¤åç¨±...">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCategoryModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">æ–°å¢</button>
                </div>
            </form>
        </div>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯æ•…äº‹çš„å½ˆçª— -->
    <div id="storyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalTitle">æ–°å¢æ•…äº‹</div>
            <form id="storyForm">
                <div class="form-group">
                    <label for="categorySelect">æ•…äº‹ç¾¤ï¼š</label>
                    <select id="categorySelect" required></select>
                </div>
                <div class="form-group">
                    <label for="storyTitle">æ•…äº‹æ¨™é¡Œï¼š</label>
                    <input type="text" id="storyTitle" required placeholder="è¼¸å…¥æ•…äº‹æ¨™é¡Œ...">
                    <div class="ai-assist-buttons">
                       
                    </div>
                    <div id="titleStatus" class="ai-status"></div>
                </div>
                <div class="form-group">
                    <label for="storyContent">æ•…äº‹å…§å®¹ï¼š</label>
                    <textarea id="storyContent" required placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ çš„æ•…äº‹..."></textarea>
                    <div class="ai-assist-buttons">
                        
                                          </div>
                    <div id="contentStatus" class="ai-status"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">å„²å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // è³‡æ–™çµæ§‹ - ä½¿ç”¨é™£åˆ—ä¿æŒé †åº
        let categoriesOrder = ["ç†Šç†Šxæˆ‘", "è¬é‡xé­ç³æ†¶", "å½±ç‰‡å¹³å°2.0"];
        let storiesData = {
            "ç†Šç†Šxæˆ‘": [],
            "è¬é‡xé­ç³æ†¶": [],
            "å½±ç‰‡å¹³å°2.0": []
        };

        let currentCategory = null;
        let currentStoryIndex = null;
        let editingStory = null;
        let currentPage = 1;
        let totalPages = 1;
        const WORDS_PER_PAGE = 500;

        // è¨ˆç®—å­—æ•¸ï¼ˆåŒ…å«ä¸­è‹±æ–‡ï¼‰
        function countWords(text) {
            if (!text) return 0;
            // ç§»é™¤ç©ºç™½å¾Œè¨ˆç®—å­—æ•¸
            return text.replace(/\s/g, '').length;
        }

        // è¨ˆç®—æ•…äº‹ç¾¤ç¸½å­—æ•¸
        function getCategoryTotalWords(categoryName) {
            if (!storiesData[categoryName]) return 0;
            return storiesData[categoryName].reduce((total, story) => {
                return total + countWords(story.content);
            }, 0);
        }

        // å°‡å…§å®¹åˆ†é 
        function paginateContent(content, wordsPerPage) {
            const totalWords = countWords(content);
            totalPages = Math.ceil(totalWords / wordsPerPage);
            
            if (totalPages <= 1) {
                return [content];
            }
            
            const pages = [];
            let currentPos = 0;
            
            for (let i = 0; i < totalPages; i++) {
                let endPos = currentPos + wordsPerPage;
                
                // æ‰¾åˆ°æœ€æ¥è¿‘çš„æ®µè½çµå°¾
                if (endPos < content.length) {
                    const nextNewline = content.indexOf('\n', endPos);
                    if (nextNewline !== -1 && nextNewline - endPos < 100) {
                        endPos = nextNewline + 1;
                    }
                }
                
                pages.push(content.substring(currentPos, Math.min(endPos, content.length)));
                currentPos = endPos;
            }
            
            return pages;
        }

        // å¾ localStorage è¼‰å…¥è³‡æ–™
        function loadData() {
            const savedData = localStorage.getItem('storiesData');
            const savedOrder = localStorage.getItem('categoriesOrder');
            
            if (savedData) {
                storiesData = JSON.parse(savedData);
            }
            if (savedOrder) {
                categoriesOrder = JSON.parse(savedOrder);
            } else {
                // å¦‚æœæ²’æœ‰ä¿å­˜é †åºï¼Œå¾storiesDataçš„keysç”Ÿæˆ
                categoriesOrder = Object.keys(storiesData);
            }
            
            // å¦‚æœæœ‰æ•…äº‹ç¾¤ï¼Œé è¨­é¸æ“‡ç¬¬ä¸€å€‹
            if (categoriesOrder.length > 0) {
                currentCategory = categoriesOrder[0];
            }
        }

        // å„²å­˜è³‡æ–™åˆ° localStorage
        function saveData() {
            localStorage.setItem('storiesData', JSON.stringify(storiesData));
            localStorage.setItem('categoriesOrder', JSON.stringify(categoriesOrder));
        }

        // å°å‡ºè³‡æ–™ç‚ºJSONæª”æ¡ˆ
        function exportData() {
            const data = {
                version: "1.0",
                exportDate: new Date().toISOString(),
                categoriesOrder: categoriesOrder,
                storiesData: storiesData
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `æ•…äº‹æ”¶è—_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert('è³‡æ–™å·²åŒ¯å‡ºï¼ä½ å¯ä»¥å°‡é€™å€‹JSONæª”æ¡ˆä¸Šå‚³åˆ°GitHubæˆ–é›²ç«¯ç¡¬ç¢Ÿä¿å­˜ã€‚');
        }

        // åŒ¯å…¥è³‡æ–™
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.categoriesOrder && data.storiesData) {
                        if (confirm('ç¢ºå®šè¦åŒ¯å…¥è³‡æ–™å—ï¼Ÿé€™å°‡æœƒè¦†è“‹ç›®å‰çš„æ‰€æœ‰æ•…äº‹ï¼')) {
                            categoriesOrder = data.categoriesOrder;
                            storiesData = data.storiesData;
                            currentCategory = categoriesOrder.length > 0 ? categoriesOrder[0] : null;
                            currentStoryIndex = null;
                            
                            saveData();
                            renderTabs();
                            renderStoriesList();
                            hidePreview();
                            
                            alert('è³‡æ–™åŒ¯å…¥æˆåŠŸï¼');
                        }
                    } else {
                        alert('æª”æ¡ˆæ ¼å¼éŒ¯èª¤ï¼');
                    }
                } catch (error) {
                    alert('è®€å–æª”æ¡ˆå¤±æ•—ï¼š' + error.message);
                }
            };
            reader.readAsText(file);
            
            // é‡ç½®inputä»¥ä¾¿å¯ä»¥é‡è¤‡åŒ¯å…¥åŒä¸€å€‹æª”æ¡ˆ
            event.target.value = '';
        }

        // åŒ¯å…¥TXTæª”æ¡ˆ
        function importTxtFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!currentCategory) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ•…äº‹ç¾¤ï¼');
                event.target.value = '';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    
                    // å˜—è©¦å¾å…§å®¹ä¸­æå–æ¨™é¡Œ
                    // æ–¹æ³•1: ç¬¬ä¸€è¡Œä½œç‚ºæ¨™é¡Œï¼Œå‰©ä¸‹çš„ä½œç‚ºå…§å®¹
                    const lines = content.split('\n');
                    let title = '';
                    let storyContent = '';
                    
                    if (lines.length > 0) {
                        // å–ç¬¬ä¸€å€‹éç©ºè¡Œä½œç‚ºæ¨™é¡Œ
                        let titleLineIndex = 0;
                        while (titleLineIndex < lines.length && lines[titleLineIndex].trim() === '') {
                            titleLineIndex++;
                        }
                        
                        if (titleLineIndex < lines.length) {
                            title = lines[titleLineIndex].trim();
                            
                            // å‰©ä¸‹çš„å…§å®¹ï¼ˆè·³éæ¨™é¡Œå¾Œçš„ç©ºè¡Œï¼‰
                            let contentStartIndex = titleLineIndex + 1;
                            while (contentStartIndex < lines.length && lines[contentStartIndex].trim() === '') {
                                contentStartIndex++;
                            }
                            
                            storyContent = lines.slice(contentStartIndex).join('\n').trim();
                        }
                    }
                    
                    // å¦‚æœæ²’æœ‰æ‰¾åˆ°æ¨™é¡Œï¼Œä½¿ç”¨æª”å
                    if (!title) {
                        title = file.name.replace('.txt', '');
                    }
                    
                    // å¦‚æœå…§å®¹ç‚ºç©ºï¼ŒæŠŠæ‰€æœ‰å…§å®¹ç•¶ä½œæ•…äº‹å…§å®¹ï¼Œä½¿ç”¨æª”åä½œç‚ºæ¨™é¡Œ
                    if (!storyContent) {
                        storyContent = content.trim();
                        title = file.name.replace('.txt', '');
                    }
                    
                    // å½ˆå‡ºå°è©±æ¡†è®“ä½¿ç”¨è€…ç¢ºèªæˆ–ä¿®æ”¹
                    const confirmedTitle = prompt('è«‹ç¢ºèªæ•…äº‹æ¨™é¡Œï¼š', title);
                    
                    if (confirmedTitle === null) {
                        // ä½¿ç”¨è€…å–æ¶ˆ
                        event.target.value = '';
                        return;
                    }
                    
                    const finalTitle = confirmedTitle.trim() || title;
                    
                    // æ–°å¢æ•…äº‹åˆ°ç•¶å‰æ•…äº‹ç¾¤
                    storiesData[currentCategory].push({
                        title: finalTitle,
                        content: storyContent
                    });
                    
                    currentStoryIndex = storiesData[currentCategory].length - 1;
                    
                    saveData();
                    renderTabs();
                    renderStoriesList();
                    showStory(currentStoryIndex);
                    
                    alert(`æ•…äº‹ã€Œ${finalTitle}ã€å·²æˆåŠŸåŒ¯å…¥åˆ°ã€Œ${currentCategory}ã€ï¼`);
                    
                } catch (error) {
                    alert('è®€å–æª”æ¡ˆå¤±æ•—ï¼š' + error.message);
                }
            };
            reader.readAsText(file, 'UTF-8');
            
            // é‡ç½®input
            event.target.value = '';
        }

        // æ¸²æŸ“æ¨™ç±¤é ï¼ˆæ”¯æ´æ‹–æ›³æ’åºï¼‰
        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';

            categoriesOrder.forEach((categoryName, index) => {
                if (!storiesData[categoryName]) return; // è·³éå·²åˆªé™¤çš„åˆ†é¡
                
                const tab = document.createElement('div');
                tab.className = 'tab' + (categoryName === currentCategory ? ' active' : '');
                tab.draggable = true;
                tab.dataset.categoryName = categoryName;
                tab.dataset.index = index;
                
                const storyCount = storiesData[categoryName].length;
                const totalWords = getCategoryTotalWords(categoryName);
                
                tab.innerHTML = `
                    <span onclick="selectCategory('${categoryName}')">${categoryName}</span>
                    <span class="story-count" onclick="selectCategory('${categoryName}')" title="${totalWords} å­—">${storyCount} ç¯‡</span>
                `;
                
                // æ‹–æ›³äº‹ä»¶
                tab.addEventListener('dragstart', handleDragStart);
                tab.addEventListener('dragover', handleDragOver);
                tab.addEventListener('drop', handleDrop);
                tab.addEventListener('dragend', handleDragEnd);
                tab.addEventListener('dragenter', handleDragEnter);
                tab.addEventListener('dragleave', handleDragLeave);
                
                container.appendChild(tab);
            });
            updateCategorySelect();
        }

        let draggedElement = null;

        function handleDragStart(e) {
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this !== draggedElement) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedElement !== this) {
                const draggedIndex = parseInt(draggedElement.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // é‡æ–°æ’åº
                const item = categoriesOrder.splice(draggedIndex, 1)[0];
                categoriesOrder.splice(targetIndex, 0, item);
                
                saveData();
                renderTabs();
            }
            
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('drag-over');
            });
        }

        // é¸æ“‡æ•…äº‹ç¾¤
        function selectCategory(categoryName) {
            currentCategory = categoryName;
            currentStoryIndex = null;
            renderTabs();
            renderStoriesList();
            hidePreview();
        }

        // æ¸²æŸ“æ•…äº‹åˆ—è¡¨
        function renderStoriesList() {
            const panel = document.getElementById('storiesListPanel');
            
            if (!currentCategory || !storiesData[currentCategory]) {
                panel.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“–</div>
                        <p>è«‹é¸æ“‡ä¸€å€‹æ•…äº‹ç¾¤</p>
                    </div>
                `;
                return;
            }

            const stories = storiesData[currentCategory];
            const totalWords = getCategoryTotalWords(currentCategory);
            
            if (stories.length === 0) {
                panel.innerHTML = `
                    <div class="list-header">
                        <div>
                            <div class="list-title">${currentCategory}</div>
                            <div class="list-meta">ç¸½å­—æ•¸: ${totalWords.toLocaleString()} å­—</div>
                        </div>
                        <button class="btn-delete-category" onclick="deleteCategoryFromList()">ğŸ—‘ï¸ åˆªé™¤æ•…äº‹ç¾¤</button>
                    </div>
                    <div class="empty-state">
                        <div class="empty-state-icon">âœ¨</div>
                        <p>é€™å€‹æ•…äº‹ç¾¤é‚„æ²’æœ‰æ•…äº‹</p>
                        <p style="margin-top: 10px; color: #bcaaa4; font-size: 0.9em;">é»æ“Šä¸Šæ–¹ã€Œ+ æ–°å¢æ•…äº‹ã€é–‹å§‹å‰µä½œ</p>
                    </div>
                `;
                return;
            }

            panel.innerHTML = `
                <div class="list-header">
                    <div>
                        <div class="list-title">${currentCategory}</div>
                        <div class="list-meta">å…± ${stories.length} ç¯‡ Â· ${totalWords.toLocaleString()} å­—</div>
                    </div>
                    <button class="btn-delete-category" onclick="deleteCategoryFromList()">ğŸ—‘ï¸ åˆªé™¤æ•…äº‹ç¾¤</button>
                </div>
                <div class="stories-list"></div>
            `;
            const storiesList = panel.querySelector('.stories-list');

            stories.forEach((story, index) => {
                const storyDiv = document.createElement('div');
                storyDiv.className = 'story-item' + (index === currentStoryIndex ? ' active' : '');
                storyDiv.draggable = true;
                storyDiv.dataset.index = index;
                storyDiv.onclick = () => showStory(index);
                
                const wordCount = countWords(story.content);
                const previewText = story.content.substring(0, 50) + (story.content.length > 50 ? '...' : '');
                
                storyDiv.innerHTML = `
                    <div class="story-title">${story.title}</div>
                    <div class="story-meta">${wordCount.toLocaleString()} å­—</div>
                    <div class="story-preview-text">${previewText}</div>
                `;
                
                // æ‹–æ›³äº‹ä»¶
                storyDiv.addEventListener('dragstart', handleStoryDragStart);
                storyDiv.addEventListener('dragover', handleStoryDragOver);
                storyDiv.addEventListener('drop', handleStoryDrop);
                storyDiv.addEventListener('dragend', handleStoryDragEnd);
                storyDiv.addEventListener('dragenter', handleStoryDragEnter);
                storyDiv.addEventListener('dragleave', handleStoryDragLeave);
                
                storiesList.appendChild(storyDiv);
            });
        }

        // æ•…äº‹æ‹–æ›³ç›¸é—œå‡½æ•¸
        let draggedStory = null;

        function handleStoryDragStart(e) {
            draggedStory = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleStoryDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleStoryDragEnter(e) {
            if (this !== draggedStory) {
                this.classList.add('drag-over');
            }
        }

        function handleStoryDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleStoryDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (draggedStory !== this) {
                const draggedIndex = parseInt(draggedStory.dataset.index);
                const targetIndex = parseInt(this.dataset.index);
                
                // é‡æ–°æ’åºæ•…äº‹
                const stories = storiesData[currentCategory];
                const item = stories.splice(draggedIndex, 1)[0];
                stories.splice(targetIndex, 0, item);
                
                // æ›´æ–°ç•¶å‰é¸ä¸­çš„ç´¢å¼•
                if (currentStoryIndex === draggedIndex) {
                    currentStoryIndex = targetIndex;
                } else if (draggedIndex < currentStoryIndex && targetIndex >= currentStoryIndex) {
                    currentStoryIndex--;
                } else if (draggedIndex > currentStoryIndex && targetIndex <= currentStoryIndex) {
                    currentStoryIndex++;
                }
                
                saveData();
                renderStoriesList();
                
                // å¦‚æœæœ‰é è¦½ï¼Œé‡æ–°é¡¯ç¤º
                if (currentStoryIndex !== null) {
                    showStory(currentStoryIndex);
                }
            }
            
            return false;
        }

        function handleStoryDragEnd(e) {
            this.classList.remove('dragging');
            
            const items = document.querySelectorAll('.story-item');
            items.forEach(item => {
                item.classList.remove('drag-over');
            });
        }

        // é¡¯ç¤ºæ•…äº‹é è¦½
        function showStory(index, page = 1) {
            currentStoryIndex = index;
            currentPage = page;
            const story = storiesData[currentCategory][index];
            
            const panel = document.getElementById('previewPanel');
            const listPanel = document.getElementById('storiesListPanel');
            
            panel.className = 'preview-panel active';
            listPanel.className = 'stories-list-panel compact';
            
            const wordCount = countWords(story.content);
            const pages = paginateContent(story.content, WORDS_PER_PAGE);
            totalPages = pages.length;
            
            // ç¢ºä¿é ç¢¼åœ¨æœ‰æ•ˆç¯„åœå…§
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            const currentContent = pages[currentPage - 1] || story.content;
            
            panel.innerHTML = `
                <div class="preview-header">
                    <div class="preview-title">${story.title}</div>
                    <div class="preview-actions">
                        <button class="btn btn-edit" onclick="editStory(${index})">âœï¸ ç·¨è¼¯</button>
                        <button class="btn btn-delete" onclick="deleteStory(${index})">ğŸ—‘ï¸ åˆªé™¤</button>
                        <button class="btn btn-export" onclick="exportStoryAsTxt(${index})">ğŸ“„ åŒ¯å‡ºTXT</button>
                    </div>
                </div>
                <div style="color: #a1887f; font-size: 0.9em; margin-bottom: 20px;">
                    ç¸½å…± ${wordCount.toLocaleString()} å­—
                </div>
                <div class="preview-content">${currentContent}</div>
                ${totalPages > 1 ? `
                    <div class="pagination-controls">
                        <button onclick="showStory(${index}, ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                            â† ä¸Šä¸€é 
                        </button>
                        <span class="page-info">${currentPage} / ${totalPages}</span>
                        <button onclick="showStory(${index}, ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                            ä¸‹ä¸€é  â†’
                        </button>
                    </div>
                ` : ''}
            `;
            
            renderStoriesList(); // é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ›´æ–°activeç‹€æ…‹
        }

        // åŒ¯å‡ºå–®å€‹æ•…äº‹ç‚ºTXT
        function exportStoryAsTxt(index) {
            const story = storiesData[currentCategory][index];
            const content = `${story.title}\n\n${story.content}`;
            
            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            
            // æ¸…ç†æª”åï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦
            const cleanTitle = story.title.replace(/[<>:"/\\|?*]/g, '_');
            link.download = `${cleanTitle}.txt`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // æ‰¹æ¬¡åŒ¯å‡ºæ•´å€‹æ•…äº‹ç¾¤ç‚ºå–®ä¸€TXTæª”æ¡ˆ
        function exportCategoryAsTxt() {
            if (!currentCategory) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ•…äº‹ç¾¤ï¼');
                return;
            }

            const stories = storiesData[currentCategory];
            if (stories.length === 0) {
                alert('é€™å€‹æ•…äº‹ç¾¤æ²’æœ‰æ•…äº‹å¯ä»¥åŒ¯å‡ºï¼');
                return;
            }

            // çµ„åˆæ‰€æœ‰æ•…äº‹
            let content = `${currentCategory}\n`;
            content += '='.repeat(currentCategory.length * 2) + '\n\n';
            
            stories.forEach((story, index) => {
                content += `ã€${index + 1}ã€‘${story.title}\n`;
                content += '-'.repeat((story.title.length + 5) * 2) + '\n\n';
                content += story.content;
                content += '\n\n\n';
            });

            const totalWords = getCategoryTotalWords(currentCategory);
            content += `\n\n--- çµ±è¨ˆè³‡è¨Š ---\n`;
            content += `æ•…äº‹æ•¸é‡: ${stories.length} ç¯‡\n`;
            content += `ç¸½å­—æ•¸: ${totalWords.toLocaleString()} å­—\n`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            
            const cleanName = currentCategory.replace(/[<>:"/\\|?*]/g, '_');
            link.download = `${cleanName}_åˆé›†.txt`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert(`å·²åŒ¯å‡ºã€Œ${currentCategory}ã€çš„ ${stories.length} ç¯‡æ•…äº‹ï¼`);
        }

        // éš±è—é è¦½
        function hidePreview() {
            const panel = document.getElementById('previewPanel');
            const listPanel = document.getElementById('storiesListPanel');
            
            panel.className = 'preview-panel';
            listPanel.className = 'stories-list-panel';
            
            panel.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">âœ¨</div>
                    <p>é»æ“Šå·¦å´æ•…äº‹æŸ¥çœ‹å…§å®¹</p>
                </div>
            `;
        }

        // é–‹å•Ÿæ–°å¢æ•…äº‹ç¾¤å½ˆçª—
        function openAddCategoryModal() {
            document.getElementById('categoryName').value = '';
            document.getElementById('categoryModal').classList.add('active');
        }

        // é—œé–‰æ•…äº‹ç¾¤å½ˆçª—
        function closeCategoryModal() {
            document.getElementById('categoryModal').classList.remove('active');
        }

        // æ–°å¢æ•…äº‹ç¾¤
        document.getElementById('categoryForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const categoryName = document.getElementById('categoryName').value.trim();
            
            if (storiesData[categoryName]) {
                alert('é€™å€‹æ•…äº‹ç¾¤å·²ç¶“å­˜åœ¨ï¼');
                return;
            }

            storiesData[categoryName] = [];
            categoriesOrder.push(categoryName); // æ·»åŠ åˆ°é †åºé™£åˆ—
            currentCategory = categoryName;
            currentStoryIndex = null;
            saveData();
            renderTabs();
            renderStoriesList();
            hidePreview();
            closeCategoryModal();
        });

        // åˆªé™¤æ•…äº‹ç¾¤
        function deleteCategory(categoryName, event) {
            event.stopPropagation();
            
            const storyCount = storiesData[categoryName].length;
            const message = storyCount > 0 
                ? `ç¢ºå®šè¦åˆªé™¤ã€Œ${categoryName}ã€å—ï¼Ÿé€™å€‹æ•…äº‹ç¾¤æœ‰ ${storyCount} ç¯‡æ•…äº‹ï¼Œåˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼`
                : `ç¢ºå®šè¦åˆªé™¤ã€Œ${categoryName}ã€å—ï¼Ÿ`;
            
            if (confirm(message)) {
                delete storiesData[categoryName];
                categoriesOrder = categoriesOrder.filter(name => name !== categoryName); // å¾é †åºé™£åˆ—ç§»é™¤
                
                // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰é¸ä¸­çš„æ•…äº‹ç¾¤ï¼Œé¸æ“‡å¦ä¸€å€‹
                if (currentCategory === categoryName) {
                    currentCategory = categoriesOrder.length > 0 ? categoriesOrder[0] : null;
                    currentStoryIndex = null;
                }
                
                saveData();
                renderTabs();
                renderStoriesList();
                hidePreview();
            }
        }

        // å¾åˆ—è¡¨é é¢åˆªé™¤ç•¶å‰æ•…äº‹ç¾¤
        function deleteCategoryFromList() {
            if (!currentCategory) return;
            
            const storyCount = storiesData[currentCategory].length;
            const message = storyCount > 0 
                ? `ç¢ºå®šè¦åˆªé™¤ã€Œ${currentCategory}ã€å—ï¼Ÿ\n\né€™å€‹æ•…äº‹ç¾¤æœ‰ ${storyCount} ç¯‡æ•…äº‹ï¼Œåˆªé™¤å¾Œå°‡ç„¡æ³•å¾©åŸï¼`
                : `ç¢ºå®šè¦åˆªé™¤ã€Œ${currentCategory}ã€å—ï¼Ÿ`;
            
            if (confirm(message)) {
                delete storiesData[currentCategory];
                categoriesOrder = categoriesOrder.filter(name => name !== currentCategory); // å¾é †åºé™£åˆ—ç§»é™¤
                
                // é¸æ“‡å¦ä¸€å€‹æ•…äº‹ç¾¤
                currentCategory = categoriesOrder.length > 0 ? categoriesOrder[0] : null;
                currentStoryIndex = null;
                
                saveData();
                renderTabs();
                renderStoriesList();
                hidePreview();
            }
        }

        // é–‹å•Ÿæ–°å¢æ•…äº‹å½ˆçª—
        function openAddStoryModal() {
            if (!currentCategory) {
                alert('è«‹å…ˆé¸æ“‡ä¸€å€‹æ•…äº‹ç¾¤ï¼');
                return;
            }

            editingStory = null;
            document.getElementById('modalTitle').textContent = 'æ–°å¢æ•…äº‹';
            document.getElementById('categorySelect').value = currentCategory;
            document.getElementById('storyTitle').value = '';
            document.getElementById('storyContent').value = '';
            document.getElementById('storyModal').classList.add('active');
        }

        // ç·¨è¼¯æ•…äº‹
        function editStory(index) {
            editingStory = index;
            const story = storiesData[currentCategory][index];
            
            document.getElementById('modalTitle').textContent = 'ç·¨è¼¯æ•…äº‹';
            document.getElementById('categorySelect').value = currentCategory;
            document.getElementById('storyTitle').value = story.title;
            document.getElementById('storyContent').value = story.content;
            document.getElementById('storyModal').classList.add('active');
        }

        // åˆªé™¤æ•…äº‹
        function deleteStory(index) {
            if (confirm('ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ•…äº‹å—ï¼Ÿ')) {
                storiesData[currentCategory].splice(index, 1);
                currentStoryIndex = null;
                saveData();
                renderTabs();
                renderStoriesList();
                hidePreview();
            }
        }

        // é—œé–‰æ•…äº‹å½ˆçª—
        function closeModal() {
            document.getElementById('storyModal').classList.remove('active');
        }

        // æ›´æ–°åˆ†é¡é¸æ“‡å™¨
        function updateCategorySelect() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '';
            
            categoriesOrder.forEach(categoryName => {
                if (storiesData[categoryName]) {
                    const option = document.createElement('option');
                    option.value = categoryName;
                    option.textContent = categoryName;
                    select.appendChild(option);
                }
            });
        }

        // è™•ç†æ•…äº‹è¡¨å–®æäº¤
        document.getElementById('storyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const category = document.getElementById('categorySelect').value;
            const title = document.getElementById('storyTitle').value;
            const content = document.getElementById('storyContent').value;

            if (editingStory !== null) {
                // ç·¨è¼¯æ¨¡å¼
                const index = editingStory;
                
                // å¦‚æœåˆ†é¡æ”¹è®Šäº†ï¼Œéœ€è¦ç§»å‹•æ•…äº‹
                if (currentCategory !== category) {
                    storiesData[currentCategory].splice(index, 1);
                    storiesData[category].push({ title, content });
                    currentCategory = category;
                    currentStoryIndex = storiesData[category].length - 1;
                } else {
                    storiesData[category][index] = { title, content };
                    currentStoryIndex = index;
                }
            } else {
                // æ–°å¢æ¨¡å¼
                storiesData[category].push({ title, content });
                currentCategory = category;
                currentStoryIndex = storiesData[category].length - 1;
            }

            saveData();
            renderTabs();
            renderStoriesList();
            showStory(currentStoryIndex);
            closeModal();
        });

        // é»æ“Šå½ˆçª—å¤–éƒ¨é—œé–‰
        document.getElementById('storyModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        document.getElementById('categoryModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCategoryModal();
            }
        });

        // åˆå§‹åŒ–
        loadData();
        renderTabs();
        renderStoriesList();

            </script>
</body>
</html>